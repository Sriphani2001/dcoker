<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Meurs</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 20px; }
    .row { margin: 10px 0; }
    input, button { padding: 8px; }
    input { width: 100%; box-sizing: border-box; }
    .tabs button { margin-right: 8px; }
    .hidden { display: none; }
    .icons { display: flex; gap: 24px; margin-top: 16px; }
    .icon { text-align: center; cursor: pointer; user-select: none; padding: 8px 12px; border: 1px solid #eee; border-radius: 10px; }
    audio, video { width: 100%; max-width: 480px; }
    #chat-log { height: 220px; overflow-y: auto; border: 1px solid #eee; padding: 8px; border-radius: 8px; background: #fafafa; }
    .chat-row { margin: 6px 0; }
    .muted { color: #777; font-size: 0.9em; }
    .row-inline > * { margin-right: 8px; }
  </style>
</head>
<body>

  <h1>Welcome to Meurs</h1>

  <!-- AUTH CARD -->
  <div id="auth-card" class="card">
    <div class="tabs">
      <button id="tab-login">Login</button>
      <button id="tab-signup">Sign up</button>
    </div>
    <div id="login-form">
      <div class="row"><input id="login-username" placeholder="Username" /></div>
      <div class="row"><input id="login-password" type="password" placeholder="Password" /></div>
      <button id="login-btn">Login</button>
    </div>
    <div id="signup-form" class="hidden">
      <div class="row"><input id="signup-username" placeholder="Username" /></div>
      <div class="row"><input id="signup-password" type="password" placeholder="Password" /></div>
      <button id="signup-btn">Create account</button>
    </div>
    <div id="auth-msg" class="row"></div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">
    <h2>Dashboard</h2>
    <div class="icons">
      <div class="icon" id="open-music">ðŸŽµ<div>Music</div></div>
      <div class="icon" id="open-videos">ðŸŽ¬<div>Videos</div></div>
      <div class="icon" id="open-comuni">ðŸ’¬<div>Comuni</div></div>
    </div>
    <div id="content-area" class="card" style="margin-top:16px;"></div>
  </div>

<script>
const API = "/api";
const STATIC_BASE = "/static";

let currentUser = null;

// Tabs
const loginForm = document.getElementById("login-form");
const signupForm = document.getElementById("signup-form");
document.getElementById("tab-login").onclick  = () => { loginForm.classList.remove("hidden"); signupForm.classList.add("hidden"); };
document.getElementById("tab-signup").onclick = () => { signupForm.classList.remove("hidden"); loginForm.classList.add("hidden"); };

const msg = (t, ok=false) => {
  const el = document.getElementById("auth-msg");
  el.style.color = ok ? "green" : "crimson";
  el.textContent = t;
};

// SIGNUP
document.getElementById("signup-btn").onclick = async () => {
  const username = document.getElementById("signup-username").value.trim();
  const password = document.getElementById("signup-password").value;
  if (!username || !password) return msg("Enter username and password");
  try {
    const res = await fetch(`${API}/signup`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, password })});
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Sign up failed");
    msg("Account created. You can log in now.", true);
    document.getElementById("tab-login").click();
  } catch (e) { msg(e.message); }
};

// LOGIN
document.getElementById("login-btn").onclick = async () => {
  const username = document.getElementById("login-username").value.trim();
  const password = document.getElementById("login-password").value;
  if (!username || !password) return msg("Enter username and password");
  try {
    const res = await fetch(`${API}/login`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, password })});
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Login failed");
    currentUser = username;
    document.getElementById("auth-card").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    msg("");
  } catch (e) { msg(e.message); }
};

// MUSIC
document.getElementById("open-music").onclick = async () => {
  const box = document.getElementById("content-area");
  box.innerHTML = "<h3>Music</h3>";
  const res = await fetch(`${API}/music`);
  const data = await res.json();
  if (!Array.isArray(data.music)) { box.textContent = "No music found"; return; }
  data.music.forEach(file => {
    const p = document.createElement("p"); p.textContent = file; box.appendChild(p);
    const audio = document.createElement("audio"); audio.controls = true;
    audio.src = `${STATIC_BASE}/music/${encodeURIComponent(file)}`;
    box.appendChild(audio);
  });
};

// VIDEOS
document.getElementById("open-videos").onclick = async () => {
  const box = document.getElementById("content-area");
  box.innerHTML = "<h3>Videos</h3>";
  const res = await fetch(`${API}/videos`);
  const data = await res.json();
  if (!Array.isArray(data.videos)) { box.textContent = "No videos found"; return; }
  data.videos.forEach(file => {
    const p = document.createElement("p"); p.textContent = file; box.appendChild(p);
    const vid = document.createElement("video"); vid.controls = true;
    vid.src = `${STATIC_BASE}/videos/${encodeURIComponent(file)}`;
    box.appendChild(vid);
  });
};


// ---------- COMUNI ----------
let ws = null;
let joinedRoom = null;
let isOwner = false;

document.getElementById("open-comuni").onclick = () => {
  const box = document.getElementById("content-area");
  box.innerHTML = `
    <h3>Comuni</h3>
    <div class="row row-inline">
      <button id="btn-create">Create room</button>
      <input id="join-id" placeholder="Enter room id (7 chars)" style="width: 240px;">
      <button id="btn-join">Join room</button>
    </div>
    <div id="room-bar" class="row hidden">
      <span>Room: <b id="room-id-label"></b></span>
      <button id="btn-exit" style="margin-left:12px;">Exit</button>
      <button id="btn-close" class="hidden" style="margin-left:8px;">Close room</button>
    </div>
    <div id="chat-area" class="hidden">
      <div id="chat-log"></div>
      <div class="row row-inline">
        <input id="chat-text" placeholder="Type a message" style="flex:1;">
        <button id="chat-send">Send</button>
      </div>
      <div class="row row-inline">
        <input type="file" id="chat-file">
        <button id="file-send">Send file</button>
      </div>
    </div>
  `;

  const chatLogEl = () => document.getElementById("chat-log");
  const clearLog  = () => { chatLogEl().innerHTML = ""; };

  const log = (html, muted=false) => {
    const el = chatLogEl();
    const row = document.createElement("div");
    row.className = "chat-row" + (muted ? " muted" : "");
    row.innerHTML = html;
    el.appendChild(row);
    el.scrollTop = el.scrollHeight;
  };

  const renderHistory = (items) => {
    clearLog();
    (items || []).forEach(m => {
      if (m.type === "chat") {
        log(`<b>${m.from}:</b> ${m.text}`);
      } else if (m.type === "file-header") {
        log(`<i>${m.from} sent: ${m.filename}</i>`, true);
      } else if (m.type === "system") {
        log(`<i>${m.text}</i>`, true);
      }
    });
  };

  const setJoined = (roomId, ownerFlag) => {
    joinedRoom = roomId;
    isOwner = !!ownerFlag;
    document.getElementById("room-id-label").textContent = roomId;
    document.getElementById("room-bar").classList.remove("hidden");
    document.getElementById("chat-area").classList.remove("hidden");
    document.getElementById("btn-close").classList.toggle("hidden", !isOwner);
  };

  const disconnect = () => {
    if (ws) { try { ws.close(); } catch(_) {} ws = null; }
    joinedRoom = null; isOwner = false;
    document.getElementById("room-bar").classList.add("hidden");
    document.getElementById("chat-area").classList.add("hidden");
  };

  const connectWS = (roomId) => {
    const proto = location.protocol === "https:" ? "wss" : "ws";
    const url = `${proto}://${location.host}/ws/comuni/${encodeURIComponent(roomId)}?user=${encodeURIComponent(currentUser)}`;
    ws = new WebSocket(url);

    ws.onopen = () => { console.log("WS open"); log(`<span class="muted">Connected.</span>`, true); };
    ws.onclose = (e) => { console.log("WS close", e); log(`<span class="muted">Disconnected.</span>`, true); };
    ws.onerror = (e) => { console.log("WS error", e); log(`<span class="muted">WS error.</span>`, true); };

    ws.onmessage = (ev) => {
      if (typeof ev.data === "string") {
        try {
          const m = JSON.parse(ev.data);
          if (m.type === "history")         renderHistory(m.items);
          else if (m.type === "clear")      clearLog();
          else if (m.type === "chat")       log(`<b>${m.from}:</b> ${m.text}`);
          else if (m.type === "system")     log(`<i>${m.text}</i>`, true);
          else if (m.type === "file-header")log(`<i>${m.from} is sending: ${m.filename}</i>`, true);
        } catch { /* ignore parse errors */ }
      } else {
        // binary file payload
        const blob = new Blob([ev.data]);
        const url = URL.createObjectURL(blob);
        log(`<a href="${url}" download>Download received file</a>`);
      }
    };
  };

  document.getElementById("btn-create").onclick = async () => {
    if (!currentUser) return alert("Login first");
    const res = await fetch(`${API}/comuni/rooms`, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username: currentUser })
    });
    const data = await res.json();
    if (!res.ok) return alert(data.detail || "Failed to create room");
    setJoined(data.room_id, true);
    connectWS(data.room_id);
  };

  document.getElementById("btn-join").onclick = async () => {
    if (!currentUser) return alert("Login first");
    const roomId = document.getElementById("join-id").value.trim();
    if (!roomId) return alert("Enter room id");
    const res = await fetch(`${API}/comuni/rooms/${encodeURIComponent(roomId)}/join`, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username: currentUser })
    });
    const data = await res.json();
    if (!res.ok) return alert(data.detail || "Failed to join");
    // Use server truth so creator regains Close button after re-joining
    setJoined(roomId, !!data.is_owner);
    connectWS(roomId);
  };

  document.getElementById("btn-exit").onclick = disconnect;

  document.getElementById("btn-close").onclick = async () => {
    // Try the server regardless of local flag; server enforces owner check
    if (!joinedRoom) return;
    const res = await fetch(`${API}/comuni/rooms/${encodeURIComponent(joinedRoom)}`, {
      method: "DELETE", headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ username: currentUser })
    });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      alert(data.detail || "Failed to close room");
      return;
    }
    disconnect();
  };

  // Send chat
  document.getElementById("chat-send").onclick = () => {
    const t = document.getElementById("chat-text").value;
    if (!t) return;
    if (!ws || ws.readyState !== 1) { log("<i>Not connected.</i>", true); return; }
    ws.send(JSON.stringify({ type: "chat", text: t }));
    // optimistic echo so you see it instantly
    log(`<b>${currentUser}:</b> ${t}`);
    document.getElementById("chat-text").value = "";
  };

  // Send file
  document.getElementById("file-send").onclick = async () => {
    if (!ws || ws.readyState !== 1) { log("<i>Not connected.</i>", true); return; }
    const f = document.getElementById("chat-file").files[0];
    if (!f) return alert("Choose a file first");
    ws.send(JSON.stringify({ type: "file", filename: f.name }));
    const buf = await f.arrayBuffer();
    ws.send(buf);
    log(`<i>You sent: ${f.name}</i>`, true);
  };
};
</script>

</body>
</html>
