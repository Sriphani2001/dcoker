<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Meurs</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#ffffff; --fg:#111; --muted:#777; --card:#f7f7f7; --border:#e5e5e5; --accent:#3b82f6;
    --radius:14px; --space:18px; --density:1;
  }
  [data-theme="dark"]{
    --bg:#0b0e11; --fg:#f5f5f5; --muted:#a0a0a0; --card:#151a20; --border:#293241; --accent:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  a{color:var(--accent);text-decoration:none}
  button{cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:10px;padding:10px 14px}
  input,select{border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--fg);padding:10px}
  .container{max-width:1000px;margin:0 auto;padding:calc(var(--space)*var(--density))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:calc(var(--space)*var(--density))}
  .row{margin:12px 0}
  .hidden{display:none !important}
  .muted{color:var(--muted)}
  /* Top nav */
  .nav{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:20}
  .nav-inner{display:flex;align-items:center;gap:14px;justify-content:space-between;padding:10px 14px}
  .brand{font-weight:800;letter-spacing:.3px}
  .tabs{display:flex;gap:8px;align-items:center}
  .tab{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid transparent}
  .tab.active{border-color:var(--border);background:var(--card)}
  .spacer{flex:1}
  .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;display:flex;align-items:center;gap:8px}
  .icon{font-size:18px}
  audio, video { width:100%; max-width:560px; border-radius:12px; }
  /* Auth box center */
  .center{display:grid;place-items:center;min-height:60vh}
  /* Profile drawer */
  .drawer{position:fixed;right:16px;top:64px;max-width:360px;width:92vw;background:var(--bg);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:16px;z-index:50}
  /* Chat */
  #chat-log{height:260px;overflow-y:auto;border:1px solid var(--border);border-radius:12px;background:var(--bg);padding:10px}
  .chat-row{margin:8px 0}
  /* Grid on Home */
  .grid{display:grid;gap:16px}
  @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>

<!-- NAVBAR -->
<div class="nav">
  <div class="nav-inner container">
    <div class="brand">MEURS</div>
    <div class="tabs">
      <button class="tab" data-route="home"><span class="icon">üè†</span>Home</button>
      <button class="tab" data-route="dashboard"><span class="icon">üìä</span>Dashboard</button>
      <button class="tab" data-route="games"><span class="icon">üéÆ</span>Games</button>
      <button class="tab" data-route="about"><span class="icon">‚ÑπÔ∏è</span>About</button>
    </div>
    <div class="spacer"></div>
    <button id="profileBtn" class="pill"><span class="icon">üë§</span><span id="profileName">Guest</span></button>
  </div>
</div>

<div class="container">

  <!-- AUTH -->
  <div id="auth" class="center">
    <div class="card" style="width:min(560px, 92vw)">
      <h2>Welcome to Meurs</h2>
      <div class="row">
        <div class="tabs">
          <button id="tab-login" class="tab active">Login</button>
          <button id="tab-signup" class="tab">Sign up</button>
        </div>
      </div>
      <div id="login-form">
        <div class="row"><input id="login-username" placeholder="Username" /></div>
        <div class="row"><input id="login-password" type="password" placeholder="Password" /></div>
        <button id="login-btn">Login</button>
      </div>
      <div id="signup-form" class="hidden">
        <div class="row"><input id="signup-username" placeholder="Username" /></div>
        <div class="row"><input id="signup-password" type="password" placeholder="Password" /></div>
        <button id="signup-btn">Create account</button>
      </div>
      <div id="auth-msg" class="row muted"></div>
    </div>
  </div>

  <!-- APP PAGES -->
  <div id="app" class="hidden">
    <div id="page"></div>
  </div>

</div>

<!-- PROFILE / SETTINGS DRAWER -->
<div id="profileDrawer" class="drawer hidden">
  <h3 style="margin:6px 0">Profile</h3>
  <div class="muted" id="profileUserLine">Signed in as </div>

  <hr class="row" style="border:none;border-top:1px solid var(--border)">

  <h4 style="margin:6px 0">Customize UI</h4>
  <div class="row">
    <label>Theme:
      <select id="themeSelect">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </label>
  </div>
  <div class="row">
    <label>Accent:
      <select id="accentSelect">
        <option value="#3b82f6">Blue</option>
        <option value="#10b981">Green</option>
        <option value="#f59e0b">Amber</option>
        <option value="#ef4444">Red</option>
        <option value="#a855f7">Purple</option>
      </select>
    </label>
  </div>
  <div class="row">
    <label>Density:
      <select id="densitySelect">
        <option value="0.9">Compact</option>
        <option value="1" selected>Cozy</option>
        <option value="1.15">Comfy</option>
      </select>
    </label>
  </div>
  <div class="row">
    <button id="closeDrawer">Close</button>
  </div>

  <div class="muted" style="font-size:.9em">Tip: Your choices are saved to this browser (localStorage).</div>
</div>

<script>
const API = "/api";
const STATIC_BASE = "/static";

/* ---------- Theme persistence ---------- */
(function loadPrefs(){
  const theme = localStorage.getItem("meurs_theme") || "light";
  const accent = localStorage.getItem("meurs_accent") || "#3b82f6";
  const density = localStorage.getItem("meurs_density") || "1";
  if(theme==="dark") document.documentElement.setAttribute("data-theme","dark");
  document.documentElement.style.setProperty("--accent", accent);
  document.documentElement.style.setProperty("--density", density);
})();

/* ---------- State ---------- */
let currentUser = null;
let ws = null, joinedRoom = null, isOwner = false;

/* ---------- Helpers ---------- */
const qs = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
const setActiveTab = route => {
  qsa(".tab[data-route]").forEach(b=>b.classList.toggle("active", b.dataset.route===route));
};
const notify = (t, ok=false) => { const el = qs("#auth-msg"); el.style.color = ok? "var(--accent)" : "var(--muted)"; el.textContent = t; };

/* ---------- Auth switching ---------- */
qs("#tab-login").onclick = () => { qs("#tab-login").classList.add("active"); qs("#tab-signup").classList.remove("active"); qs("#login-form").classList.remove("hidden"); qs("#signup-form").classList.add("hidden"); };
qs("#tab-signup").onclick = () => { qs("#tab-signup").classList.add("active"); qs("#tab-login").classList.remove("active"); qs("#signup-form").classList.remove("hidden"); qs("#login-form").classList.add("hidden"); };

/* ---------- Signup ---------- */
qs("#signup-btn").onclick = async () => {
  const username = qs("#signup-username").value.trim();
  const password = qs("#signup-password").value;
  if(!username||!password) return notify("Enter username & password");
  const r = await fetch(`${API}/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})});
  const d = await r.json(); if(!r.ok) return notify(d.detail||"Sign up failed");
  notify("Account created. You can log in now.",true);
  qs("#tab-login").click();
};

/* ---------- Login ---------- */
qs("#login-btn").onclick = async () => {
  const username = qs("#login-username").value.trim();
  const password = qs("#login-password").value;
  if(!username||!password) return notify("Enter username & password");
  const r = await fetch(`${API}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})});
  const d = await r.json(); if(!r.ok) return notify(d.detail||"Login failed");
  currentUser = username;
  qs("#profileName").textContent = currentUser;
  qs("#profileUserLine").textContent = `Signed in as ${currentUser}`;
  qs("#auth").classList.add("hidden");
  qs("#app").classList.remove("hidden");
  // default route
  routeTo("home");
};

/* ---------- Router ---------- */
qsa(".tab[data-route]").forEach(btn=>{
  btn.addEventListener("click", ()=>routeTo(btn.dataset.route));
});

function routeTo(route){
  setActiveTab(route);
  const page = qs("#page");
  if(route==="home") renderHome(page);
  else if(route==="dashboard") renderDashboard(page);
  else if(route==="games") renderGames(page);
  else if(route==="about") renderAbout(page);
}

/* ---------- Profile / Settings ---------- */
qs("#profileBtn").onclick = ()=> { qs("#profileDrawer").classList.toggle("hidden"); };
qs("#closeDrawer").onclick = ()=> qs("#profileDrawer").classList.add("hidden");
qs("#themeSelect").onchange = e => {
  const v = e.target.value; localStorage.setItem("meurs_theme", v);
  if(v==="dark") document.documentElement.setAttribute("data-theme","dark");
  else document.documentElement.removeAttribute("data-theme");
};
qs("#accentSelect").onchange = e => {
  const v = e.target.value; localStorage.setItem("meurs_accent", v); document.documentElement.style.setProperty("--accent", v);
};
qs("#densitySelect").onchange = e => {
  const v = e.target.value; localStorage.setItem("meurs_density", v); document.documentElement.style.setProperty("--density", v);
};

/* ---------- Pages ---------- */
function renderHome(page){
  page.innerHTML = `
    <h2>Home</h2>
    <div class="grid grid-2">
      <div class="card">
        <h3>Music</h3>
        <div id="home-music">Loading‚Ä¶</div>
      </div>
      <div class="card">
        <h3>Videos</h3>
        <div id="home-videos">Loading‚Ä¶</div>
      </div>
    </div>
    <div class="row muted">Tip: You can move Music/Videos to Dashboard later if you prefer ‚Äî we‚Äôll add a toggle in settings.</div>
  `;
  loadMusic("#home-music");
  loadVideos("#home-videos");
}

function renderDashboard(page){
  page.innerHTML = `
    <h2>Dashboard</h2>
    <div class="card">
      <h3>Comuni</h3>
      <div class="row">
        <button id="btn-create">Create room</button>
        <input id="join-id" placeholder="Enter room id (7 chars)" style="width:240px">
        <button id="btn-join">Join room</button>
      </div>
      <div id="room-bar" class="row hidden">
        <span>Room: <b id="room-id-label"></b></span>
        <button id="btn-exit" style="margin-left:12px;">Exit</button>
        <button id="btn-close" class="hidden" style="margin-left:8px;">Close room</button>
      </div>
      <div id="chat-area" class="hidden">
        <div id="chat-log"></div>
        <div class="row" style="display:flex;gap:8px">
          <textarea id="chat-text" placeholder="Type a message (Enter = send, Shift+Enter = newline)" rows="2" style="flex:1"></textarea>
          <button id="chat-send">Send</button>
        </div>
        <div class="row" style="display:flex;gap:8px;align-items:center">
          <input type="file" id="chat-file">
          <button id="file-send">Send file</button>
        </div>
      </div>
    </div>
  `;
  wireComuni();
}

function renderGames(page){
  page.innerHTML = `
    <h2>Games</h2>
    <div class="card">
      <p>This is a placeholder for mini-games (e.g., Tic-Tac-Toe, 2048, Snake). You can decide in <b>Profile ‚Üí Customize UI</b> whether ‚ÄúGames‚Äù lives here as its own tab, or appears inside <b>Home</b> or <b>Dashboard</b>. For now it‚Äôs a separate tab.</p>
      <p class="muted">Want me to drop in a quick Tic-Tac-Toe component next?</p>
    </div>
  `;
}

function renderAbout(page){
  page.innerHTML = `
    <h2>About</h2>
    <div class="card">
      <p><b>Meurs</b> is a personal media & communication hub. Play your local music/videos, and use <b>Comuni</b> to chat and share files directly via your server ‚Äî no storage, just relay.</p>
      <ul>
        <li>Home: Music & Videos</li>
        <li>Dashboard: Comuni rooms</li>
        <li>Games: placeholder for your mini-games</li>
        <li>Profile (top right): your username + UI customization</li>
      </ul>
    </div>
  `;
}

/* ---------- Media loaders ---------- */
async function loadMusic(sel){
  const box = qs(sel); box.textContent = "Loading‚Ä¶";
  try{
    const r = await fetch(`${API}/music`); const d = await r.json();
    if(!Array.isArray(d.music) || d.music.length===0){ box.textContent="No music found"; return; }
    box.innerHTML = "";
    d.music.forEach(file=>{
      const wrap = document.createElement("div"); wrap.className="row";
      wrap.innerHTML = `<div class="muted">${file}</div>`;
      const a = document.createElement("audio"); a.controls = true; a.src = `${STATIC_BASE}/music/${encodeURIComponent(file)}`;
      wrap.appendChild(a); box.appendChild(wrap);
    });
  }catch(e){ box.textContent = "Failed to load music"; }
}

async function loadVideos(sel){
  const box = qs(sel); box.textContent = "Loading‚Ä¶";
  try{
    const r = await fetch(`${API}/videos`); const d = await r.json();
    if(!Array.isArray(d.videos) || d.videos.length===0){ box.textContent="No videos found"; return; }
    box.innerHTML = "";
    d.videos.forEach(file=>{
      const wrap = document.createElement("div"); wrap.className="row";
      wrap.innerHTML = `<div class="muted">${file}</div>`;
      const v = document.createElement("video"); v.controls = true; v.src = `${STATIC_BASE}/videos/${encodeURIComponent(file)}`;
      wrap.appendChild(v); box.appendChild(wrap);
    });
  }catch(e){ box.textContent = "Failed to load videos"; }
}

/* ---------- Comuni wiring ---------- */
function wireComuni(){
  const roomBar = qs("#room-bar");
  const chatArea = qs("#chat-area");
  const roomLabel = qs("#room-id-label");
  const chatLog = qs("#chat-log");
  const clearLog = ()=>{ chatLog.innerHTML = ""; };
  const log = (html, muted=false)=>{ const row=document.createElement("div"); row.className="chat-row"+(muted?" muted":""); row.innerHTML=html; chatLog.appendChild(row); chatLog.scrollTop=chatLog.scrollHeight; };
  const renderHistory = items => { clearLog(); (items||[]).forEach(m=>{ if(m.type==="chat") log(`<b>${m.from}:</b> ${m.text}`); else if(m.type==="file-header") log(`<i>${m.from} sent: ${m.filename}</i>`,true); else if(m.type==="system") log(`<i>${m.text}</i>`,true); }); };

  let incomingFilename = null;

  function setJoined(roomId, owner){
    joinedRoom = roomId; isOwner = !!owner; roomLabel.textContent = roomId;
    roomBar.classList.remove("hidden"); chatArea.classList.remove("hidden");
    qs("#btn-close").classList.toggle("hidden", !isOwner);
  }
  function disconnect(){
    if(ws){ try{ ws.close(); }catch{} ws=null; }
    joinedRoom=null; isOwner=false; roomBar.classList.add("hidden"); chatArea.classList.add("hidden");
  }

  function connectWS(roomId){
    const proto = location.protocol==="https:" ? "wss" : "ws";
    const url = `${proto}://${location.host}/ws/comuni/${encodeURIComponent(roomId)}?user=${encodeURIComponent(currentUser)}`;
    ws = new WebSocket(url);
    ws.onopen  = ()=>log(`<span class="muted">Connected.</span>`,true);
    ws.onclose = ()=>log(`<span class="muted">Disconnected.</span>`,true);
    ws.onerror = ()=>log(`<span class="muted">WS error.</span>`,true);
    ws.onmessage = ev => {
      if(typeof ev.data === "string"){
        try{
          const m = JSON.parse(ev.data);
          if(m.type==="history") renderHistory(m.items);
          else if(m.type==="clear") clearLog();
          else if(m.type==="chat") log(`<b>${m.from}:</b> ${m.text}`);
          else if(m.type==="system") log(`<i>${m.text}</i>`,true);
          else if(m.type==="file-header"){ incomingFilename=m.filename||"file.bin"; log(`<i>${m.from} is sending: ${m.filename}</i>`,true); }
        }catch{}
      }else{
        const blob = new Blob([ev.data]); const url = URL.createObjectURL(blob);
        const name = incomingFilename || "file.bin"; incomingFilename=null;
        log(`<a href="${url}" download="${name}">Download: ${name}</a>`);
      }
    };
  }

  qs("#btn-create").onclick = async ()=>{
    const r = await fetch(`${API}/comuni/rooms`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser})});
    const d = await r.json(); if(!r.ok) return alert(d.detail||"Failed to create room");
    setJoined(d.room_id, true); connectWS(d.room_id); wireSendHandlers();
  };

  qs("#btn-join").onclick = async ()=>{
    const id = qs("#join-id").value.trim(); if(!id) return alert("Enter room id");
    const r = await fetch(`${API}/comuni/rooms/${encodeURIComponent(id)}/join`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser})});
    const d = await r.json(); if(!r.ok) return alert(d.detail||"Failed to join");
    setJoined(id, !!d.is_owner); connectWS(id); wireSendHandlers();
  };

  qs("#btn-exit").onclick = disconnect;

  qs("#btn-close").onclick = async ()=>{
    if(!joinedRoom) return;
    const r = await fetch(`${API}/comuni/rooms/${encodeURIComponent(joinedRoom)}`, {method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser})});
    if(!r.ok){ const d = await r.json().catch(()=>({})); alert(d.detail||"Failed to close room"); return; }
    disconnect();
  };

  function wireSendHandlers(){
    const input = qs("#chat-text");
    const sendBtn = qs("#chat-send");
    const fileBtn = qs("#file-send");
    const fileInput = qs("#chat-file");

    input.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});
    sendBtn.onclick = ()=>{
      const t = input.value.trim(); if(!t) return;
      if(!ws || ws.readyState!==1){ log("<i>Not connected.</i>",true); return; }
      ws.send(JSON.stringify({type:"chat", text:t}));
      input.value="";
    };
    fileBtn.onclick = async ()=>{
      if(!ws || ws.readyState!==1){ log("<i>Not connected.</i>",true); return; }
      const f = fileInput.files[0]; if(!f) return alert("Choose a file first");
      ws.send(JSON.stringify({type:"file", filename:f.name}));
      setTimeout(async ()=>{ const buf = await f.arrayBuffer(); ws.send(buf); }, 50);
      log(`<i>You sent: ${f.name}</i>`, true);
      fileInput.value="";
    };
  }
}

/* ---------- end ---------- */
</script>
</body>
</html>
